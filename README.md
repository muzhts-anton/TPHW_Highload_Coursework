# Evernote
## 1. Тема и целевая аудитория
Evernote — компания, расположенная в городе Саннивейл (Калифорния, США), к числу основных бизнес-направлений которой относится разработка и продвижение на рынок одноименного сервиса сохранения и синхронизации заметок, а также лицензирования ряда запатентованных технологий компании, включая распознавание печатного и рукописного текста в изображениях. Компания имеет представительства в России и Великобритании.

Evernote используют в своей работе люди из 190 стран мира. Территориально аудитория Evernote распределена следующим образом:
* Азиатско-Тихоокеанский регион — 35 млн человек;
* Европа, Ближний Восток и Африка — 31 млн;
* США и Канада — 27 млн;
* Латинская Америка — 8 млн.

![image](https://user-images.githubusercontent.com/64084206/202904381-f4c8d706-f0a9-4e2e-959d-fc58847e7975.png)

Аудитория evernote.com составляет 61.56% мужчин и 38.44% женщин. Самая большая возрастная группа посетителей 25-34 года (Desktop).

Основной функционал:

создание и хранение заметок. В качестве заметки может выступать фрагмент форматированного текста, веб-страница целиком, фотография, аудиофайл или рукописная запись. Заметки могут также содержать вложения с файлами другого типа. Заметки можно сортировать по блокнотам, присваивать им метки, редактировать и экспортировать.

## 2. Расчет нагрузки
![image](https://user-images.githubusercontent.com/64084206/203305249-5126ac3e-3f49-446a-ae49-3d82423af478.png)

Продуктовые метрики:
* Месячная аудитория: 28 млн [8]
* Дневная аудитория: 3 млн [5]
* Основные пользовательские сценарии:
  - Авторизация / регистрация
  - Создание / редактирование / просмотр заметки
  - Сортировка заметок по блокнотам
  - Присвоение заметкам метки
  - Создание ярлыков
* Средний размер хранилища:
  - Основная сущность: заметки. Доля платных пользователей - около 25% [2]. На одного бесплатного пользователя отведем в месяц 20 Мб, на платного - 500Мб [6]. Положим, что в среднем в месяц каждый пользователь заходит 4 раза в неделю, т.е. 16 раз в месяц. Тогда получаем ``` (28 000 000 / 16) * .25 * 500Мб + (28 000 000 / 16) * (1 - .25) * 20Мб = 215000Гб + 26000Гб = 241Тб ``` за месяц. Это около 3000Тб в год.
* Сетевой трафик:
  - Принимая в рассчет указанные выше числа, получаем, что сетевой трафик составляет приближенно сумму составляющих нагрузки, отвечающих за *работу с заметкой* и подгрузкой *списка всех имеющихся заметок* пользователя. Положим, что у пользователя в среднем 15 заметок, для шапки каждой из которых требуется 100Кб. Тогда получаем нагрузку, равную ``` 0.6782Гб/с + 0.04967Гб/с = 0.72787Гб/с = 5.82296Гбит/с ```. Эта оценка включает в себя работу с любым видом заметок, отображения списка всех заметок и пренебрегает авторизацией и регистрацией, так как соответсвующие им добавки к нагрузке незначительны.
  - В качестве пиковой нагрузки примем единовременную активность порядка 30% уникальных пользователей от дневной нормы: ``` 652.313Гбит/с ```
* RPS:
  - Работа с заметками занимает у пользователя в среднем 5 минут [8]. Т.о. получаем: ``` 3 000 000 * 5 * 60 / (24 * 60 * 60) = 10417 RPS ```.
  - Регистрация пренебрежима мала, в то время как для авторизации: ``` 3 000 000 / (24 * 60 * 60) / 2 = 17 RPS ```.
  - Получение списка всех своих заметок: ``` 3 000 000 / (24 * 60 * 60) = 35 RPS ```.
  - Итого: ``` 28169 RPS ```.
  - Однако, конечно, нельзя предполагать, что распределение запросов будет равномерно в сутки. Если рассмотреть ситуацию, когда приблизительно 30% уникальных ежедневных пользователей единовременно воспользуется сервисом, получим пиковое значение RPS, равное ``` 150000 RPS ```.

## 3. Логическая схема
![image](https://user-images.githubusercontent.com/64084206/203425284-1a0c4609-5e32-425c-a412-41703f3ba86e.png)

## 4. Физическая схема
![image](https://user-images.githubusercontent.com/64084206/203425900-8f1d055f-02bf-435e-b92b-fee8afcc26ac.png)

В качестве базы данных под текстовую информацию подходит PostgreSQL. Это решение одно из наиболее функционально, надежно, с большим комьюнити разработчиков и специалистов.

Для медиафайлов при необходимости можно обратиться к Amazon S3 - онлайн веб-службе, предлагаемой Amazon Web Services, предоставляющей возможность хранения и получения любого объёма данных в любое время из любой точки сети, - так называемому файловому хостингу. Заметим, что в PSQL таблице на диаграмме хранятся пути до файлов, тогда как могут сами файлы храниться в Amazon S3. Для сессий подойдут самые распрастраненные решения на рынке - Tarantool или Redis.

Таблицу необходимо шардировать, так как количество заметок всех пользователей всего сервиса предполагается крайне большим. Сегментирование — подход, предполагающий разделение баз данных, отдельных её объектов или индексов поисковых систем на независимые сегменты, каждый из которых управляется отдельным экземпляром сервера базы данных, размещаемым, как правило, на отдельном вычислительном узле.

Если общее число пользователей - 101 млн и у каждого есть хотя бы 3 заметки, получаем минимум 300 млн строк. Положим количество шардов равным 300 шт, в каждом по миллиону элементов. Подобные рассуждения имеют отношение и к таблице меток. Также было бы не лишено смысла реплицировать хранилище тех данных, изменение которых не предполагается: аудиоматриалы или изображение, т.е. Amazon S3.

## 5. Технологии
* Фронтенд
  - TypeScript благодаря типизации.
* Балансировка нагрузки
  - Nginx как одно из самых распространненных решений.
* Бэкенд
  - Golang за удобную встроенную асинхронность и полную совместимость с микросервисной архитектурой.
  - gRPC для удобного использования protobuff на http/2 при коммуникации микросервисов.
* База данных
  - PostgreSQL
  - Amazon S3
  - Tarantool

## 6. Итоговая схема
В качестве одного из возможных вариантов выделим следующие микросервисы:
* Авторизация / регистрация.
* Работа с заметками:
  - Создание и добавление меток.
  - Создание и редактирование заметок.
  - Удаление заметки (работа с корзиной).
  - Создание и редактирование блокнотов.
  - Создание и удаление ярлыков.

В таком случае итоговая схема будет выглядеть таким образом:
![image](https://user-images.githubusercontent.com/64084206/203818238-c17e7a44-40b5-442c-95b2-a35e758f0c02.png)

## 7. Список серверов
Имеем пиковую сетевую нагрузку 652.313 Гбит/с и пиковое кол-во запросов в секунду 150000 RPS.

Для Nginx получаем 150000 / 77000 = 3 сервера по RPS, 652 / 40 = 17 серверов по сетевому трафику [9].

Конфигурация:
* CPU 16 ядер
* 40Гбит/с
* 17 штук

Микросервисы:

Согласно [10] сервер с данной конфигурацией выдерживает 30 000 RPS:

CPU: KVM Virtual CPU version(2 GHz, 4 cores) Memory: 16G Go: go1.18.5 linux/amd64 OS: Ubuntu 22.04.1 LTS with Kernel 5.15.0-41-generic

Необходимое количество: 150000 / 30000 = 5 штук.

Базы данных:

В рассчете на 5 лет имеем 3000Тб * 5 = 15Пб

Для PSQL из [11] берем в рассчет 5000QPS: 150000 / 5000 = 30 серверов.

Tarantool является in-memory хранилищем, следовательно требуется большой объём оперативной памяти:

* 2 CPU
* 32Гб RAM
* 20Гб HDD

## 8. Источники
1. https://ru.wikipedia.org/wiki/Evernote
2. https://www.tadviser.ru/index.php/%D0%9A%D0%BE%D0%BC%D0%BF%D0%B0%D0%BD%D0%B8%D1%8F:Evernote
3. https://www.cnews.ru/news/top/auditoriya_evernote_prevysila_100_mln
4. https://image3.slideserve.com/6236724/slide19-l.jpg
5. https://habr.com/ru/company/evernote/blog/107938/
6. https://help.evernote.com/hc/ru/articles/209005247-%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%BD%D1%8B%D0%B5-%D0%BE%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D1%8F-Evernote
7. https://ru.wikipedia.org/wiki/Amazon_S3
8. https://www.similarweb.com/ru/website/evernote.com/#traffic
9. https://www.nginx.com/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers/
10. https://github.com/smallnest/go-web-framework-benchmark
11. https://www.ashnik.com/fine-tuning-postgres-to-achieve-5000-queries-per-second/
